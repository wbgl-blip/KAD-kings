<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>KAD Kings</title>

<style>
  :root{
    --bg:#000;
    --tileBorder: rgba(255,255,255,0.06);
    --white:#fff;

    --tileW: 156px;
    --tileH: 190px;
    --avatar: 52px;

    --cardW: 220px;
    --cardH: 300px;

    --titleSize: 48px;
    --subSize: 13px;

    --btnPadY: 12px;
    --btnPadX: 22px;
  }

  *{box-sizing:border-box}

  html, body{
    margin:0;
    height:100%;
    overflow:hidden;
    background: var(--bg);
    color: var(--white);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
  }

  .bg1{
    position:fixed; inset:0;
    background: radial-gradient(circle at center, rgba(255,255,255,0.085) 0%, rgba(0,0,0,0.92) 55%, rgba(0,0,0,1) 100%);
    pointer-events:none;
  }
  .bg2{
    position:fixed; inset:0;
    opacity:.26;
    filter: blur(52px);
    background:
      radial-gradient(circle at 18% 26%, rgba(255,255,255,0.11), transparent 46%),
      radial-gradient(circle at 76% 62%, rgba(255,255,255,0.09), transparent 42%);
    pointer-events:none;
  }

  .app{
    position:relative;
    height:100svh;
    height:100dvh;
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  h1{
    margin: 12px 0 6px;
    font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
    font-size: var(--titleSize);
    font-weight: 700;
    letter-spacing: 0.05em;
    text-align:center;
    line-height:1;
  }

  .turnBanner{
    margin: 0 0 10px;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.12);
    box-shadow: 0 14px 34px rgba(0,0,0,.40);
    font-weight: 1000;
    letter-spacing: .12em;
    text-transform: uppercase;
    font-size: 12px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .turnDot{
    width:10px; height:10px; border-radius:999px;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 0 0 0 rgba(255,255,255,0.35);
    animation: pulse 1.2s infinite;
  }
  @keyframes pulse{
    0%{ box-shadow: 0 0 0 0 rgba(255,255,255,0.30); }
    70%{ box-shadow: 0 0 0 12px rgba(255,255,255,0.00); }
    100%{ box-shadow: 0 0 0 0 rgba(255,255,255,0.00); }
  }
  .turnSmall{
    opacity:.75;
    font-weight: 900;
    letter-spacing: .06em;
    font-size: 11px;
    text-transform:none;
  }

  .stage{
    position:relative;
    width:min(980px, 96vw);
    height: calc(100% - 118px); /* title + banner */
    max-height: 820px;
  }

  .scaleWrap{
    position:relative;
    width:100%;
    height:100%;
    transform-origin: top center;
  }

  .pos{ position:absolute; transform:translate(-50%,-50%); }

  .tile{
    width: var(--tileW);
    height: var(--tileH);
    border-radius: 22px;
    background: rgba(11,11,11,.96);
    border: 1px solid var(--tileBorder);
    box-shadow: 0 22px 54px rgba(0,0,0,0.78);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:space-between;
    padding: 16px 16px 14px;
    position:relative;
    cursor:pointer; /* tap to set turn */
  }

  .tile.turn{
    border-color: rgba(255,255,255,0.28);
    box-shadow:
      0 0 0 2px rgba(255,255,255,0.10),
      0 0 0 10px rgba(255,255,255,0.03),
      0 28px 70px rgba(255,255,255,0.06),
      0 22px 54px rgba(0,0,0,0.78);
  }

  .turnTag{
    position:absolute;
    top: 10px;
    right: 10px;
    font-size: 11px;
    font-weight: 1000;
    letter-spacing: .10em;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.14);
    border: 1px solid rgba(255,255,255,0.14);
    opacity:.95;
    display:none;
  }
  .tile.turn .turnTag{ display:block; }

  .targetTag{
    position:absolute;
    left: 10px;
    top: 10px;
    font-size: 11px;
    font-weight: 1000;
    letter-spacing: .10em;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.14);
    opacity:.92;
    display:none;
  }
  .tile.targeting .targetTag{ display:block; }

  .avatar{
    width: var(--avatar);
    height: var(--avatar);
    border-radius: 999px;
    background: rgba(255,255,255,.35);
  }

  .name{
    margin-top:-6px;
    font-weight:950;
    font-size: 17px;
    text-align:center;
  }

  .stats{
    margin-top:6px;
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    font-size: 14px;
    opacity:.92;
    font-weight:800;
  }

  .pill{
    margin-top:10px;
    font-weight:1000;
    font-size: 13px;
    background:#fff;
    color:#000;
    border:0;
    border-radius: 12px;
    padding: 8px 13px;
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
    cursor:pointer;
  }
  .pill:active{ transform:scale(.99); }

  .card{
    width: var(--cardW);
    height: var(--cardH);
    background:#fff;
    color:#000;
    border-radius: 22px;
    box-shadow: 0 18px 46px rgba(0,0,0,.6);
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 0 22px;
    text-align:center;
    font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
    font-weight: 800;
    font-size: 22px;
    line-height: 1.15;
  }

  .drawBtn{
    position:absolute;
    left:50%;
    bottom: 14px;
    transform: translateX(-50%);
    background:#fff;
    color:#000;
    border:0;
    border-radius: 12px;
    font-weight: 1000;
    letter-spacing: .09em;
    padding: var(--btnPadY) var(--btnPadX);
    box-shadow: 0 14px 34px rgba(0,0,0,.50);
    cursor:pointer;
    z-index: 6;
  }
  .drawBtn:active{ transform: translateX(-50%) scale(.99); }

  .ghostBtn{
    position:absolute;
    left:50%;
    bottom: 14px;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.12);
    color:#fff;
    border: 1px solid rgba(255,255,255,0.16);
    border-radius: 12px;
    font-weight: 1000;
    letter-spacing: .09em;
    padding: var(--btnPadY) var(--btnPadX);
    box-shadow: 0 14px 34px rgba(0,0,0,.40);
    cursor:pointer;
    z-index: 6;
    display:none;
  }
  .ghostBtn:active{ transform: translateX(-50%) scale(.99); }

  /* Layout positions */
  .p-top-mid{   left:52%; top:13%; }
  .p-top-left{  left:32%; top:18%; }
  .p-top-right{ left:72%; top:18%; }
  .p-mid-left{  left:25%; top:56%; }
  .p-mid-right{ left:69%; top:56%; }
  .p-bot-left{  left:32%; top:88%; }

  .center{ left:50%; top:58%; }

  .panel{
    position:absolute;
    right: 6px;
    top: 56%;
    transform: translateY(-50%);
    width: 210px;
    padding: 12px;
    border-radius: 18px;
    background: rgba(11,11,11,.92);
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: 0 18px 42px rgba(0,0,0,0.72);
    display:flex;
    flex-direction:column;
    gap:12px;
    z-index: 5;
  }

  .sectionTitle{
    font-weight: 1000;
    letter-spacing: .06em;
    font-size: 12px;
    opacity: .9;
    text-transform: uppercase;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .chip{
    font-size: 11px;
    font-weight: 1000;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.10);
    opacity:.9;
  }

  .stickyGrid{ display:flex; flex-direction:column; gap:8px; }

  .stickyRow{
    padding: 10px 10px;
    border-radius: 14px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }

  .stickyLabel{
    font-size: 12px;
    font-weight: 1000;
    letter-spacing:.02em;
    opacity:.9;
  }

  .stickyValue{
    font-size: 12px;
    font-weight: 1000;
    opacity:.85;
    text-align:right;
    max-width: 120px;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .stickyOn{
    background: rgba(255,255,255,0.14);
    border-color: rgba(255,255,255,0.16);
  }

  .miniGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
  }
  .powerBtn{
    border:0;
    border-radius: 14px;
    padding: 10px 10px;
    font-weight: 1000;
    letter-spacing: .06em;
    cursor:pointer;
    background: rgba(255,255,255,0.10);
    color:#fff;
    border: 1px solid rgba(255,255,255,0.12);
  }
  .powerBtn:active{ transform: scale(.99); }
  .powerBtn.primary{
    background:#fff;
    color:#000;
    border-color: rgba(255,255,255,0.40);
  }
  .powerBtn.warn{
    background: rgba(255,255,255,0.16);
    border-color: rgba(255,255,255,0.18);
  }
  .powerBtn[disabled]{
    opacity:.45;
    cursor:not-allowed;
  }

  .rulesList{ display:flex; flex-direction:column; gap:8px; overflow:hidden; }

  .ruleItem{
    padding: 10px 10px;
    border-radius: 14px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    font-size: 13px;
    line-height: 1.2;
    font-weight: 800;
  }

  .ruleMeta{
    margin-top: 6px;
    font-size: 11px;
    opacity: .7;
    font-weight: 900;
    letter-spacing: .02em;
  }

  .btnRow{ display:flex; gap:8px; }

  .miniBtn{
    flex:1;
    border:0;
    border-radius: 12px;
    padding: 8px 10px;
    font-weight: 1000;
    cursor:pointer;
  }
  .miniBtn.light{ background:#fff; color:#000; }
  .miniBtn.dark{ background: rgba(255,255,255,0.10); color:#fff; border: 1px solid rgba(255,255,255,0.12); }
  .miniBtn:active{ transform: scale(.99); }

  .historyWrap{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    justify-content:flex-start;
  }
  .hist{
    font-size: 12px;
    font-weight: 1000;
    padding: 6px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.10);
    opacity:.95;
  }

  /* Small modal */
  .modalBack{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 50;
    padding: 16px;
  }
  .modal{
    width:min(420px, 92vw);
    border-radius: 18px;
    background: rgba(11,11,11,.96);
    border: 1px solid rgba(255,255,255,0.10);
    box-shadow: 0 30px 90px rgba(0,0,0,.75);
    padding: 14px;
  }
  .modalTitle{
    font-weight: 1000;
    letter-spacing: .08em;
    text-transform: uppercase;
    font-size: 12px;
    opacity:.92;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .modalBody{
    margin-top: 10px;
    font-size: 14px;
    font-weight: 800;
    opacity:.92;
    line-height:1.25;
  }
  .modalBtns{
    margin-top: 12px;
    display:flex;
    gap:10px;
  }
  .modalBtns button{
    flex:1;
    border:0;
    border-radius: 12px;
    padding: 10px 10px;
    font-weight: 1000;
    cursor:pointer;
  }
  .modalBtns .ok{ background:#fff; color:#000; }
  .modalBtns .cancel{ background: rgba(255,255,255,0.10); color:#fff; border: 1px solid rgba(255,255,255,0.12); }

  @media (max-width: 480px){
    :root{
      --tileW: 106px;
      --tileH: 130px;
      --avatar: 34px;
      --cardW: 180px;
      --cardH: 240px;
      --titleSize: 32px;
      --btnPadY: 9px;
      --btnPadX: 14px;
    }

    .turnBanner{ font-size: 11px; padding: 7px 10px; }
    .turnSmall{ display:none; }

    .name{ font-size: 13px; }
    .stats{ font-size: 12px; gap:6px; }
    .pill{ font-size: 11px; padding: 6px 9px; border-radius: 10px; }
    .card{ font-size: 19px; }

    .p-top-mid{   left:52%; top:14%; }
    .p-top-left{  left:30%; top:18%; }
    .p-top-right{ left:72%; top:18%; }
    .p-mid-left{  left:18%; top:54%; }
    .p-mid-right{ left:66%; top:54%; }
    .p-bot-left{  left:30%; top:88%; }
    .center{ left:50%; top:58%; }

    .stage{ height: calc(100% - 108px); }

    .panel{
      right: 6px;
      top: 69%;
      width: 176px;
      padding: 10px;
      gap:10px;
    }

    .ruleItem{ font-size: 12px; padding: 8px 8px; }
    .hist{ font-size: 11px; padding: 5px 7px; }

    .powerBtn{ padding: 9px 8px; font-size: 12px; }
  }

  @media (max-height: 740px){
    :root{
      --tileW: 132px;
      --tileH: 162px;
      --avatar: 46px;
      --cardW: 210px;
      --cardH: 280px;
      --titleSize: 40px;
    }
  }
</style>
</head>

<body>
  <div class="bg1"></div>
  <div class="bg2"></div>

  <div class="app">
    <h1>KAD Kings</h1>

    <div class="turnBanner">
      <span class="turnDot"></span>
      <span id="turnBannerText">MIKE‚ÄôS TURN</span>
      <span class="turnSmall">tap a player to set turn</span>
    </div>

    <div class="stage" id="stage">
      <div class="scaleWrap" id="scaleWrap">

        <div class="pos center">
          <div class="card" id="centerCard">Draw a card<br/>No mercy</div>
        </div>

        <div class="panel" id="panel">
          <div class="sectionTitle">
            Progress <span class="chip" id="progressChip">0 / 52</span>
          </div>

          <div class="sectionTitle">
            History <span class="chip" id="leftChip">52 left</span>
          </div>
          <div class="historyWrap" id="historyWrap"></div>

          <div class="sectionTitle" style="margin-top:6px;">
            Sticky Powers <span class="chip">LIVE</span>
          </div>

          <div class="stickyGrid">
            <div class="stickyRow" id="thumbRow">
              <div class="stickyLabel">Thumbmaster (J)</div>
              <div class="stickyValue" id="thumbVal">None</div>
            </div>

            <div class="stickyRow" id="questionRow">
              <div class="stickyLabel">Question Master (Q)</div>
              <div class="stickyValue" id="questionVal">None</div>
            </div>

            <div class="stickyRow" id="heavenRow">
              <div class="stickyLabel">Heaven (7)</div>
              <div class="stickyValue" id="heavenVal">None</div>
            </div>
          </div>

          <div class="miniGrid">
            <button class="powerBtn warn" id="thumbActionBtn" disabled>THUMB (J)</button>
            <button class="powerBtn warn" id="heavenActionBtn" disabled>HEAVEN (7)</button>
            <button class="powerBtn warn" id="questionActionBtn" disabled>QUESTION (Q)</button>
            <button class="powerBtn primary" id="clearModesBtn">CLEAR</button>
          </div>

          <div class="sectionTitle">
            Active Rules <span class="chip" id="rulesCount">0</span>
          </div>

          <div class="rulesList" id="rulesList">
            <div class="ruleItem" style="opacity:.75">
              No rules yet.
              <div class="ruleMeta">Draw a King to add one.</div>
            </div>
          </div>

          <div class="btnRow">
            <button class="miniBtn dark" id="addRuleBtn">+ Rule</button>
            <button class="miniBtn light" id="clearRulesBtn">Clear</button>
          </div>
        </div>

        <button class="drawBtn" id="drawBtn">DRAW CARD</button>
        <button class="ghostBtn" id="restartBtn">RESTART DECK</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalTitle">
        <span id="modalTitle">INFO</span>
        <span class="chip" id="modalChip">LIVE</span>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalBtns">
        <button class="cancel" id="modalCancel">Close</button>
        <button class="ok" id="modalOk">OK</button>
      </div>
    </div>
  </div>

<script>
  const players = [
    {id:"beau",  name:"Beau",  drinks:0, pos:"p-top-left"},
    {id:"mike",  name:"Mike",  drinks:0, pos:"p-top-mid"},
    {id:"jess",  name:"Jess",  drinks:0, pos:"p-top-right"},
    {id:"alex",  name:"Alex",  drinks:0, pos:"p-mid-left"},
    {id:"emily", name:"Emily", drinks:0, pos:"p-mid-right"},
    {id:"sean",  name:"Sean",  drinks:0, pos:"p-bot-left"},
  ];

  const kingsRules = {
    A: "Waterfall ‚Äì everyone drinks, no stopping",
    "2": "You ‚Äì choose someone to drink",
    "3": "Me ‚Äì you drink",
    "4": "For whores ‚Äì everyone drinks",
    "5": "Guys ‚Äì all guys drink",
    "6": "For dicks ‚Äì everyone drinks",
    "7": "Heaven ‚Äì last to point to heaven drinks",
    "8": "Mate ‚Äì pick a drinking buddy",
    "9": "Rhyme ‚Äì say a word, others rhyme",
    "10": "Categories ‚Äì pick a category",
    J: "Thumbmaster ‚Äì last thumb down drinks",
    Q: "Question master ‚Äì answer questions or drink",
    K: "King ‚Äì make a rule"
  };

  const stage = document.getElementById("stage");
  const wrap = document.getElementById("scaleWrap");
  const centerCard = document.getElementById("centerCard");
  const drawBtn = document.getElementById("drawBtn");
  const restartBtn = document.getElementById("restartBtn");

  const thumbRow = document.getElementById("thumbRow");
  const questionRow = document.getElementById("questionRow");
  const heavenRow = document.getElementById("heavenRow");
  const thumbVal = document.getElementById("thumbVal");
  const questionVal = document.getElementById("questionVal");
  const heavenVal = document.getElementById("heavenVal");

  const rulesCount = document.getElementById("rulesCount");
  const rulesList = document.getElementById("rulesList");
  const addRuleBtn = document.getElementById("addRuleBtn");
  const clearRulesBtn = document.getElementById("clearRulesBtn");

  const progressChip = document.getElementById("progressChip");
  const leftChip = document.getElementById("leftChip");
  const historyWrap = document.getElementById("historyWrap");

  const turnBannerText = document.getElementById("turnBannerText");

  const thumbActionBtn = document.getElementById("thumbActionBtn");
  const heavenActionBtn = document.getElementById("heavenActionBtn");
  const questionActionBtn = document.getElementById("questionActionBtn");
  const clearModesBtn = document.getElementById("clearModesBtn");

  const modalBack = document.getElementById("modalBack");
  const modalTitle = document.getElementById("modalTitle");
  const modalChip = document.getElementById("modalChip");
  const modalBody = document.getElementById("modalBody");
  const modalCancel = document.getElementById("modalCancel");
  const modalOk = document.getElementById("modalOk");

  const activeRules = [];
  const sticky = { thumbmaster:null, questionMaster:null, heavenMaster:null };

  let turnIdx = 0;
  let history = [];
  let deck = [];
  let idx = 0;

  // Action modes for sticky gameplay
  let mode = "none"; // none | heaven_pick | thumb_arm | thumb_pick
  let modeLabel = "";

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function buildDeck(){
    const suits = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
    const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    const d = [];
    for (const r of ranks) for (const s of suits) d.push(`${r}${s}`);
    d.sort(() => Math.random() - 0.5);
    return d;
  }

  function showModal(title, body, chip="LIVE", okText="OK"){
    modalTitle.textContent = title;
    modalChip.textContent = chip;
    modalBody.innerHTML = body;
    modalOk.textContent = okText;
    modalBack.style.display = "flex";
  }
  function closeModal(){ modalBack.style.display = "none"; }
  modalCancel.addEventListener("click", closeModal);

  function renderSticky(){
    thumbVal.textContent = sticky.thumbmaster || "None";
    questionVal.textContent = sticky.questionMaster || "None";
    heavenVal.textContent = sticky.heavenMaster || "None";

    thumbRow.classList.toggle("stickyOn", !!sticky.thumbmaster);
    questionRow.classList.toggle("stickyOn", !!sticky.questionMaster);
    heavenRow.classList.toggle("stickyOn", !!sticky.heavenMaster);

    // enable action buttons if the sticky exists
    thumbActionBtn.disabled = !sticky.thumbmaster;
    questionActionBtn.disabled = !sticky.questionMaster;
    heavenActionBtn.disabled = !sticky.heavenMaster;
  }

  function renderRules(){
    rulesCount.textContent = String(activeRules.length);
    const shown = activeRules.slice(-6).reverse();

    if (shown.length === 0){
      rulesList.innerHTML = `
        <div class="ruleItem" style="opacity:.75">
          No rules yet.
          <div class="ruleMeta">Draw a King to add one.</div>
        </div>
      `;
      return;
    }

    rulesList.innerHTML = shown.map((r, i) => {
      const n = activeRules.length - i;
      return `
        <div class="ruleItem">
          ${escapeHtml(r.text)}
          <div class="ruleMeta">Rule #${n}${r.by ? " ‚Ä¢ by " + escapeHtml(r.by) : ""}</div>
        </div>
      `;
    }).join("");
  }

  function promptForRule(who){
    const text = prompt("New rule (King):", "");
    if (!text) return;
    activeRules.push({ text: text.trim(), by: who || "" });
    renderRules();
    fitToScreen();
  }

  addRuleBtn.addEventListener("click", () => promptForRule("manual"));
  clearRulesBtn.addEventListener("click", () => {
    if (!activeRules.length) return;
    if (!confirm("Clear all active rules?")) return;
    activeRules.length = 0;
    renderRules();
    fitToScreen();
  });

  function tileHTML(p){
    return `
      <div class="pos ${p.pos}" data-id="${p.id}">
        <div class="tile" id="tile-${p.id}">
          <div class="turnTag">TURN</div>
          <div class="targetTag">PICK</div>
          <div class="avatar"></div>
          <div>
            <div class="name">${p.name}</div>
            <div class="stats"><span>üç∫</span><span class="drinkCount">${p.drinks}</span></div>
          </div>
          <button class="pill" data-plus="1">+1 Beer</button>
        </div>
      </div>
    `;
  }

  wrap.insertAdjacentHTML("afterbegin", players.map(tileHTML).join(""));

  // +1 Beer button
  wrap.querySelectorAll(".pos[data-id] .pill").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const root = e.target.closest(".pos[data-id]");
      const id = root.getAttribute("data-id");
      addDrink(id, 1);
    });
  });

  // Tap player tile (set turn OR use pick mode)
  wrap.querySelectorAll(".pos[data-id] .tile").forEach((tile) => {
    tile.addEventListener("click", (e) => {
      const root = e.currentTarget.closest(".pos[data-id]");
      const id = root.getAttribute("data-id");

      if (mode === "heaven_pick"){
        // Heaven: pick loser
        addDrink(id, 1);
        showToast(`${players.find(p=>p.id===id).name} drinks (Heaven 7)`);
        clearModes();
        return;
      }

      if (mode === "thumb_pick"){
        // Thumb: pick loser (manual)
        addDrink(id, 1);
        showToast(`${players.find(p=>p.id===id).name} drinks (Thumb J)`);
        clearModes();
        return;
      }

      // default: set turn
      const idx = players.findIndex(p => p.id === id);
      if (idx >= 0) setTurn(idx);
    });
  });

  function addDrink(playerId, amount){
    const p = players.find(x => x.id === playerId);
    if (!p) return;
    p.drinks += amount;
    const tile = document.getElementById(`tile-${p.id}`);
    tile.querySelector(".drinkCount").textContent = p.drinks;
  }

  function setTurn(newTurnIdx){
    turnIdx = (newTurnIdx + players.length) % players.length;
    const who = players[turnIdx].name;

    // Banner text
    turnBannerText.textContent = `${who.toUpperCase()}‚ÄôS TURN`;

    // Tile highlight
    players.forEach(p => {
      const el = document.getElementById(`tile-${p.id}`);
      if (!el) return;
      el.classList.toggle("turn", p === players[turnIdx]);
    });

    fitToScreen();
  }

  function renderHistory(){
    historyWrap.innerHTML = history.slice(0, 6).map(h => {
      return `<div class="hist">${escapeHtml(h.card)}</div>`;
    }).join("");

    progressChip.textContent = `${idx} / 52`;
    leftChip.textContent = `${52 - idx} left`;
  }

  function endState(){
    centerCard.innerHTML = `
      <div style="font-size:20px;font-weight:900;line-height:1.15">
        All 52 cards drawn<br/>
        <span style="font-size:14px;opacity:.8;font-family:system-ui">Restart?</span>
      </div>
    `;
    drawBtn.style.display = "none";
    restartBtn.style.display = "block";
  }

  function normalState(){
    drawBtn.style.display = "block";
    restartBtn.style.display = "none";
  }

  function restartGame(){
    deck = buildDeck();
    idx = 0;
    history = [];
    sticky.thumbmaster = null;
    sticky.questionMaster = null;
    sticky.heavenMaster = null;
    clearModes();
    normalState();
    renderSticky();
    renderHistory();
    setTurn(0);
    centerCard.innerHTML = "Draw a card<br/>No mercy";
    fitToScreen();
  }

  restartBtn.addEventListener("click", restartGame);

  function drawCard(){
    if (idx >= deck.length){
      endState();
      return;
    }

    const drawer = players[turnIdx].name;
    const card = deck[idx++];
    const rank = card.slice(0, -1);
    const rule = kingsRules[rank] || "";

    if (rank === "J") sticky.thumbmaster = drawer;
    if (rank === "Q") sticky.questionMaster = drawer;
    if (rank === "7") sticky.heavenMaster = drawer;

    if (rank === "K") setTimeout(() => promptForRule(drawer), 20);

    history.unshift({ card, by: drawer, rank });

    renderSticky();
    renderHistory();

    let stickyHint = "";
    if (rank === "J") stickyHint = `<div style="margin-top:8px;font-size:12px;opacity:.78;font-family:system-ui;font-weight:900">Thumbmaster: ${escapeHtml(drawer)} (tap THUMB to play)</div>`;
    if (rank === "Q") stickyHint = `<div style="margin-top:8px;font-size:12px;opacity:.78;font-family:system-ui;font-weight:900">Question Master: ${escapeHtml(drawer)} (tap QUESTION)</div>`;
    if (rank === "7") stickyHint = `<div style="margin-top:8px;font-size:12px;opacity:.78;font-family:system-ui;font-weight:900">Heaven: ${escapeHtml(drawer)} (tap HEAVEN to pick)</div>`;

    centerCard.innerHTML = `
      <div style="font-size:40px;font-weight:900;margin-bottom:6px">
        ${card}
      </div>
      <div style="font-size:14px;font-weight:900;opacity:.92;line-height:1.2;font-family:system-ui">
        ${escapeHtml(rule)}
      </div>
      ${stickyHint}
      <div style="margin-top:8px;font-size:12px;opacity:.65;font-family:system-ui;font-weight:900">
        Drew: ${escapeHtml(drawer)}
      </div>
    `;

    // Advance turn after draw
    setTurn(turnIdx + 1);

    if (idx >= 52){
      setTimeout(endState, 80);
    }

    fitToScreen();
  }

  drawBtn.addEventListener("click", drawCard);

  // ---------- Sticky Actions (Playable) ----------
  function setMode(nextMode, label){
    mode = nextMode;
    modeLabel = label || "";

    // mark tiles as targeting if we need a player pick
    const needsPick = (mode === "heaven_pick" || mode === "thumb_pick");
    players.forEach(p => {
      const el = document.getElementById(`tile-${p.id}`);
      if (!el) return;
      el.classList.toggle("targeting", needsPick);
    });

    if (needsPick){
      showToast(modeLabel);
    }
  }

  function clearModes(){
    mode = "none";
    modeLabel = "";
    players.forEach(p => {
      const el = document.getElementById(`tile-${p.id}`);
      if (!el) return;
      el.classList.remove("targeting");
    });
  }

  thumbActionBtn.addEventListener("click", () => {
    if (!sticky.thumbmaster) return;

    // 2-step: arm -> pick loser
    if (mode !== "thumb_pick"){
      setMode("thumb_pick", "THUMB ROUND: tap the loser (last thumb down)");
      showModal("Thumbmaster (J)", `
        <div style="opacity:.9;font-weight:900">
          ${escapeHtml(sticky.thumbmaster)} is Thumbmaster.
        </div>
        <div style="margin-top:8px;opacity:.85">
          Tap <b>THUMB (J)</b>, then tap the player who drank.
        </div>
      `, "J", "Got it");
      modalOk.onclick = () => { closeModal(); };
    }
  });

  heavenActionBtn.addEventListener("click", () => {
    if (!sticky.heavenMaster) return;
    setMode("heaven_pick", "HEAVEN (7): tap the loser (last to point up)");
    showModal("Heaven (7)", `
      <div style="opacity:.9;font-weight:900">
        ${escapeHtml(sticky.heavenMaster)} owns Heaven.
      </div>
      <div style="margin-top:8px;opacity:.85">
        Tap <b>HEAVEN (7)</b>, then tap the player who drank.
      </div>
    `, "7", "Start");
    modalOk.onclick = () => { closeModal(); };
  });

  questionActionBtn.addEventListener("click", () => {
    if (!sticky.questionMaster) return;
    showModal("Question Master (Q)", `
      <div style="opacity:.9;font-weight:900">
        ${escapeHtml(sticky.questionMaster)} is Question Master.
      </div>
      <div style="margin-top:8px;opacity:.85">
        If you answer their questions, you drink.
      </div>
      <div style="margin-top:10px;opacity:.75;font-size:12px">
        Tip: tap a player tile anytime to set the next turn.
      </div>
    `, "Q", "OK");
    modalOk.onclick = () => { closeModal(); };
  });

  clearModesBtn.addEventListener("click", () => {
    clearModes();
    showToast("CLEARED");
  });

  // ---------- Tiny Toast ----------
  let toastTimer = null;
  function showToast(text){
    let el = document.getElementById("toast");
    if (!el){
      el = document.createElement("div");
      el.id = "toast";
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.bottom = "22px";
      el.style.transform = "translateX(-50%)";
      el.style.padding = "10px 12px";
      el.style.borderRadius = "999px";
      el.style.background = "rgba(11,11,11,.92)";
      el.style.border = "1px solid rgba(255,255,255,0.12)";
      el.style.color = "#fff";
      el.style.fontWeight = "1000";
      el.style.letterSpacing = ".06em";
      el.style.fontSize = "12px";
      el.style.boxShadow = "0 16px 42px rgba(0,0,0,.65)";
      el.style.zIndex = "60";
      el.style.maxWidth = "92vw";
      el.style.whiteSpace = "nowrap";
      el.style.overflow = "hidden";
      el.style.textOverflow = "ellipsis";
      document.body.appendChild(el);
    }
    el.textContent = text;

    clearTimeout(toastTimer);
    el.style.opacity = "1";
    toastTimer = setTimeout(() => {
      el.style.opacity = "0";
    }, 1600);
  }

  // ---------- Fit-to-screen ----------
  function fitToScreen(){
    if (!stage || !wrap) return;
    wrap.style.transform = "scale(1)";
    const stageRect = stage.getBoundingClientRect();
    const wrapRect = wrap.getBoundingClientRect();
    const scaleX = stageRect.width / wrapRect.width;
    const scaleY = stageRect.height / wrapRect.height;
    wrap.style.transform = `scale(${Math.min(1, scaleX, scaleY)})`;
  }

  window.addEventListener("load", () => {
    deck = buildDeck();
    renderSticky();
    renderRules();
    renderHistory();
    setTurn(0);
    fitToScreen();
  });

  window.addEventListener("resize", () => requestAnimationFrame(fitToScreen));
  window.addEventListener("orientationchange", () => setTimeout(fitToScreen, 60));
</script>
</body>
</html>
