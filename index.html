<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>KAD Kings</title>

<style>
  :root{
    --bg:#000;
    --white:#fff;
    --panel: rgba(12,12,12,.92);
    --line: rgba(255,255,255,.10);
    --soft: rgba(255,255,255,.06);

    --title: 44px;

    --tileW: 150px;
    --tileH: 180px;
    --avatar: 50px;

    --cardW: 180px;
    --cardH: 240px;

    --btnY: 10px;
    --btnX: 18px;
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;
    height:100%;
    overflow:hidden;
    background:var(--bg);
    color:var(--white);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    -webkit-user-select:none;
    user-select:none;
    touch-action: manipulation;
  }

  .bg1{
    position:fixed; inset:0;
    background: radial-gradient(circle at center, rgba(255,255,255,0.085) 0%, rgba(0,0,0,0.92) 58%, rgba(0,0,0,1) 100%);
    pointer-events:none;
  }
  .bg2{
    position:fixed; inset:0;
    opacity:.22;
    filter: blur(52px);
    background:
      radial-gradient(circle at 22% 30%, rgba(255,255,255,0.11), transparent 46%),
      radial-gradient(circle at 76% 62%, rgba(255,255,255,0.09), transparent 42%);
    pointer-events:none;
  }

  .app{
    position:relative;
    height:100svh;
    height:100dvh;
    height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding: 8px 10px calc(12px + env(safe-area-inset-bottom, 0px));
    gap: 10px;
  }

  h1{
    margin: 6px 0 0;
    font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
    font-size: var(--title);
    font-weight: 800;
    letter-spacing: .06em;
    line-height: 1;
    text-align:center;
  }

  /* Top status / round banner */
  .statusBar{
    width: min(860px, 96vw);
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    z-index: 50;
  }

  .pill{
    display:flex;
    align-items:center;
    gap:10px;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: 0 18px 46px rgba(0,0,0,.55);
    font-weight: 1000;
    letter-spacing:.12em;
    text-transform: uppercase;
    font-size: 11px;
    backdrop-filter: blur(6px);
  }

  .dot{
    width: 9px; height: 9px;
    border-radius: 999px;
    background: rgba(255,255,255,.92);
    box-shadow: 0 0 0 0 rgba(255,255,255,0.28);
    animation: pulse 1.2s infinite;
  }
  @keyframes pulse{
    0%{ box-shadow: 0 0 0 0 rgba(255,255,255,0.26); }
    70%{ box-shadow: 0 0 0 14px rgba(255,255,255,0.00); }
    100%{ box-shadow: 0 0 0 0 rgba(255,255,255,0.00); }
  }

  .roundPill{
    display:none;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.18);
    font-weight: 1000;
    letter-spacing: .10em;
    text-transform: uppercase;
    font-size: 11px;
  }
  body.roundActive .roundPill{ display:flex; align-items:center; gap:10px; }
  .flash{
    animation: flash 0.8s infinite;
  }
  @keyframes flash{
    0%, 100%{ filter: brightness(1); }
    50%{ filter: brightness(1.35); }
  }

  /* Main stage */
  .stage{
    width: min(980px, 96vw);
    flex: 1;
    display:flex;
    align-items:stretch;
    justify-content:center;
    gap: 14px;
    position: relative;
    z-index: 10;
    min-height: 0;
  }

  /* Desktop layout: board + side panel */
  .board{
    flex: 1;
    min-width: 0;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }

  .side{
    width: 260px;
    background: var(--panel);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 20px;
    box-shadow: 0 22px 64px rgba(0,0,0,.72);
    padding: 12px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .sectionTitle{
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight: 1000;
    letter-spacing:.08em;
    text-transform:uppercase;
    font-size: 12px;
    opacity:.92;
  }
  .chip{
    font-size: 11px;
    font-weight: 1000;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    border: 1px solid rgba(255,255,255,0.10);
    opacity:.95;
  }

  .row{
    padding: 10px 10px;
    border-radius: 14px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.06);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
  }
  .row strong{ font-size: 12px; letter-spacing:.02em; }
  .row span{
    font-size: 12px;
    font-weight: 900;
    opacity:.85;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 120px;
    text-align:right;
  }

  .grid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:8px;
  }
  .btn{
    border:0;
    border-radius: 14px;
    padding: 10px 10px;
    font-weight: 1000;
    letter-spacing:.06em;
    cursor:pointer;
    background: rgba(255,255,255,0.10);
    color:#fff;
    border: 1px solid rgba(255,255,255,0.12);
  }
  .btn.primary{
    background:#fff;
    color:#000;
    border-color: rgba(255,255,255,0.38);
  }
  .btn[disabled]{ opacity:.45; cursor:not-allowed; }
  .btn.flashBtn{ animation: flash 0.8s infinite; }

  .historyWrap{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .hist{
    font-size: 12px;
    font-weight: 1000;
    padding: 6px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.10);
    opacity:.95;
  }

  /* Card + players area (desktop uses a neat grid too, no overlap) */
  .boardGrid{
    width: 100%;
    max-width: 680px;
    height: 100%;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    grid-template-rows: auto 1fr auto;
    gap: 14px;
    align-items:center;
    justify-items:center;
  }

  .centerWrap{
    grid-column: 2;
    grid-row: 2;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }

  .card{
    width: var(--cardW);
    height: var(--cardH);
    background:#fff;
    color:#000;
    border-radius: 22px;
    box-shadow: 0 18px 52px rgba(0,0,0,.55);
    display:flex;
    flex-direction:column;
    padding: 14px 16px 12px;
    text-align:center;
    font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
    font-weight: 900;
    line-height: 1.15;
  }
  .cardTop{
    display:flex;
    align-items:flex-start;
    justify-content:center;
    gap:10px;
    min-height: 52px;
  }
  .cardFace{
    font-size: 28px;
    font-weight: 1000;
    line-height: 1;
  }
  .cardRule{
    font-size: 12px;
    font-weight: 1000;
    font-family: system-ui;
    opacity:.86;
    line-height: 1.15;
    text-align:left;
    max-width: 110px;
  }
  .cardMid{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 18px;
    padding: 8px 8px;
  }
  .cardFooter{
    font-family: system-ui;
    font-size: 11px;
    font-weight: 1000;
    opacity:.65;
    min-height: 16px;
  }

  .drawBtn{
    background:#fff;
    color:#000;
    border:0;
    border-radius: 14px;
    font-weight: 1000;
    letter-spacing:.10em;
    padding: var(--btnY) var(--btnX);
    box-shadow: 0 14px 34px rgba(0,0,0,.50);
    cursor:pointer;
  }
  .drawBtn:active{ transform: scale(.99); }

  /* Player tile */
  .tile{
    width: var(--tileW);
    height: var(--tileH);
    border-radius: 22px;
    background: rgba(11,11,11,.96);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 18px 44px rgba(0,0,0,0.72);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:space-between;
    padding: 14px 14px 12px;
    position:relative;
    overflow:hidden;
  }

  /* Turn highlight without scaling */
  .tile.turn{
    border-color: rgba(255,255,255,0.30);
    box-shadow:
      0 0 0 2px rgba(255,255,255,0.10),
      0 26px 70px rgba(0,0,0,0.82),
      0 0 60px rgba(255,255,255,0.10);
  }
  .turnTag{
    position:absolute;
    top:10px; right:10px;
    font-size: 11px;
    font-weight: 1000;
    letter-spacing:.10em;
    padding: 4px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.16);
    border: 1px solid rgba(255,255,255,0.18);
    opacity:.95;
    display:none;
  }
  .tile.turn .turnTag{ display:block; }

  .avatar{
    width: var(--avatar);
    height: var(--avatar);
    border-radius: 999px;
    background: rgba(255,255,255,.35);
  }
  .name{
    margin-top:-6px;
    font-weight: 1000;
    font-size: 17px;
    text-align:center;
  }
  .stats{
    margin-top:6px;
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    font-size: 14px;
    opacity:.92;
    font-weight: 900;
  }

  .plusBtn{
    width: 100%;
    border:0;
    border-radius: 12px;
    padding: 9px 10px;
    font-weight: 1000;
    background:#fff;
    color:#000;
    cursor:pointer;
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }
  .plusBtn:active{ transform: scale(.99); }

  /* Round reaction button (shows only during round) */
  .reactBtn{
    width: 100%;
    border:0;
    border-radius: 12px;
    padding: 10px 10px;
    font-weight: 1000;
    letter-spacing:.10em;
    background: rgba(255,255,255,0.12);
    color:#fff;
    border: 1px solid rgba(255,255,255,0.14);
    cursor:pointer;
    display:none;
  }
  .reactBtn.flashBtn{ animation: flash 0.8s infinite; }
  .reactBtn:active{ transform: scale(.99); }

  body.roundActive .plusBtn{ display:none; }
  body.roundActive .reactBtn{ display:block; }

  /* Toast */
  #toast{
    position:fixed;
    left:50%;
    bottom: calc(18px + env(safe-area-inset-bottom, 0px));
    transform:translateX(-50%);
    padding:10px 12px;
    border-radius:999px;
    background:rgba(12,12,12,.92);
    border:1px solid rgba(255,255,255,0.12);
    color:#fff;
    font-weight:1000;
    letter-spacing:.06em;
    font-size:12px;
    box-shadow:0 16px 42px rgba(0,0,0,.65);
    z-index:200;
    max-width:92vw;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    opacity:0;
    transition: opacity .15s ease;
    pointer-events:none;
  }

  /* Mobile: hide side panel, use bottom sheet */
  .hudBtn{
    display:none;
    position:fixed;
    right: 12px;
    bottom: calc(92px + env(safe-area-inset-bottom, 0px));
    width: 56px; height: 56px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(12,12,12,.92);
    box-shadow: 0 18px 46px rgba(0,0,0,.70);
    color:#fff;
    font-weight: 1000;
    font-size: 22px;
    cursor:pointer;
    z-index: 150;
  }

  .sheetOverlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.55);
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease;
    z-index: 180;
  }
  .sheet{
    position:fixed;
    left: 0; right: 0;
    bottom: -100%;
    padding: 12px 12px calc(18px + env(safe-area-inset-bottom, 0px));
    transition: bottom .22s ease;
    z-index: 190;
  }
  .sheetInner{
    margin: 0 auto;
    width: min(520px, 96vw);
    background: rgba(12,12,12,.96);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 22px;
    box-shadow: 0 26px 70px rgba(0,0,0,0.80);
    padding: 12px;
    max-height: 72vh;
    overflow:auto;
  }
  .grabber{
    height: 5px; width: 44px;
    border-radius: 999px;
    background: rgba(255,255,255,0.18);
    margin: 0 auto 10px;
  }
  .sheetTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom: 10px;
  }
  .closeBtn{
    border:0;
    background: rgba(255,255,255,0.10);
    color:#fff;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 8px 10px;
    font-weight:1000;
    cursor:pointer;
  }

  body.sheetOpen .sheetOverlay{ opacity:1; pointer-events:auto; }
  body.sheetOpen .sheet{ bottom: 10px; }

  @media (max-width: 600px){
    :root{
      --title: 38px;

      --tileW: 122px;
      --tileH: 150px;
      --avatar: 38px;

      --cardW: 150px;
      --cardH: 190px;

      --btnY: 9px;
      --btnX: 14px;
    }

    .stage{ width: 96vw; gap:0; }
    .side{ display:none; }
    .hudBtn{ display:block; }

    /* Mobile grid (no overlap possible) */
    .boardGrid{
      max-width: 460px;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 12px;
      align-content: center;
      padding-bottom: 58px; /* breathing room above toast/hud */
    }

    /* Place players by row */
    #slot-top-left{ grid-column:1; grid-row:1; }
    #slot-top-mid{  grid-column:2; grid-row:1; }
    #slot-top-right{grid-column:3; grid-row:1; }

    #slot-mid-left{ grid-column:1; grid-row:2; }
    #slot-center{   grid-column:2; grid-row:2; }
    #slot-mid-right{grid-column:3; grid-row:2; }

    #slot-bot-left{ grid-column:1; grid-row:3; }
    #slot-bot-mid{  grid-column:2; grid-row:3; } /* unused spacer */
    #slot-bot-right{grid-column:3; grid-row:3; } /* unused spacer */

    .name{ font-size: 14px; }
    .stats{ font-size: 13px; }
    .cardFace{ font-size: 24px; }
    .cardRule{ font-size: 11px; max-width: 86px; }
    .cardMid{ font-size: 16px; }
  }
</style>
</head>

<body>
<div class="bg1"></div>
<div class="bg2"></div>

<div class="app">
  <h1>KAD Kings</h1>

  <div class="statusBar">
    <div class="pill" id="turnPill">
      <span class="dot"></span>
      <span id="turnText">BEAU‚ÄôS TURN</span>
      <span style="opacity:.7; font-weight:900; letter-spacing:.06em; text-transform:none;" id="turnHint">tap a player to set turn</span>
    </div>

    <div class="roundPill flash" id="roundPill">
      <span style="width:9px;height:9px;border-radius:999px;background:rgba(255,255,255,.92);"></span>
      <span id="roundText">THUMBS! REACT</span>
      <span style="opacity:.75; font-weight:900; letter-spacing:.06em;" id="roundSub">everyone tap REACT</span>
    </div>
  </div>

  <div class="stage">
    <div class="board">
      <div class="boardGrid" id="boardGrid">

        <!-- TOP -->
        <div id="slot-top-left"></div>
        <div id="slot-top-mid"></div>
        <div id="slot-top-right"></div>

        <!-- MID -->
        <div id="slot-mid-left"></div>

        <div id="slot-center" class="centerWrap">
          <div class="card" id="centerCard">
            <div class="cardMid">Draw a card<br/>No mercy</div>
            <div class="cardFooter" style="visibility:hidden"></div>
          </div>
          <button class="drawBtn" id="drawBtn">DRAW CARD</button>
        </div>

        <div id="slot-mid-right"></div>

        <!-- BOT -->
        <div id="slot-bot-left"></div>
        <div id="slot-bot-mid"></div>
        <div id="slot-bot-right"></div>

      </div>
    </div>

    <!-- Desktop side panel -->
    <aside class="side" id="sidePanel">
      <div class="sectionTitle">Progress <span class="chip" id="progressChip">0 / 52</span></div>
      <div class="sectionTitle">History <span class="chip" id="leftChip">52 left</span></div>
      <div class="historyWrap" id="historyWrap"></div>

      <div class="sectionTitle" style="margin-top:4px;">Sticky Powers</div>
      <div class="row" id="thumbRow"><strong>Thumbmaster (J)</strong><span id="thumbVal">None</span></div>
      <div class="row" id="heavenRow"><strong>Heaven (7)</strong><span id="heavenVal">None</span></div>

      <div class="grid2">
        <button class="btn" id="startJBtn" disabled>START J</button>
        <button class="btn" id="start7Btn" disabled>START 7</button>
      </div>

      <div class="grid2">
        <button class="btn" id="clearRoundBtn">CLEAR</button>
        <button class="btn primary" id="restartDeckBtn">RESTART</button>
      </div>
    </aside>
  </div>
</div>

<button class="hudBtn" id="hudBtn">‚ò∞</button>

<div class="sheetOverlay" id="sheetOverlay"></div>
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="grabber"></div>
    <div class="sheetTop">
      <div style="font-weight:1000;letter-spacing:.08em;text-transform:uppercase;opacity:.9;">Game Panel</div>
      <button class="closeBtn" id="sheetClose">Close</button>
    </div>

    <div class="sectionTitle">Progress <span class="chip" id="mProgressChip">0 / 52</span></div>
    <div class="sectionTitle">History <span class="chip" id="mLeftChip">52 left</span></div>
    <div class="historyWrap" id="mHistoryWrap" style="margin-top:8px;"></div>

    <div class="sectionTitle" style="margin-top:14px;">Sticky Powers</div>
    <div class="row" id="mThumbRow"><strong>Thumbmaster (J)</strong><span id="mThumbVal">None</span></div>
    <div class="row" id="mHeavenRow"><strong>Heaven (7)</strong><span id="mHeavenVal">None</span></div>

    <div class="grid2" style="margin-top:10px;">
      <button class="btn" id="mStartJBtn" disabled>START J</button>
      <button class="btn" id="mStart7Btn" disabled>START 7</button>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <button class="btn" id="mClearRoundBtn">CLEAR</button>
      <button class="btn primary" id="mRestartDeckBtn">RESTART</button>
    </div>

    <div style="margin-top:12px;opacity:.75;font-weight:900;font-size:12px;line-height:1.2;">
      J / 7 flow: power owner hits START (flashes). Everyone puts thumb down / finger up, then taps REACT.
      Last REACT gets +1 drink.
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
  const players = [
    {id:"beau",  name:"Beau",  drinks:0, slot:"slot-top-left"},
    {id:"mike",  name:"Mike",  drinks:0, slot:"slot-top-mid"},
    {id:"jess",  name:"Jess",  drinks:0, slot:"slot-top-right"},
    {id:"alex",  name:"Alex",  drinks:0, slot:"slot-mid-left"},
    {id:"emily", name:"Emily", drinks:0, slot:"slot-mid-right"},
    {id:"sean",  name:"Sean",  drinks:0, slot:"slot-bot-left"},
  ];

  // Your rules
  const rules = {
    "4": "4 for whores ‚Äì we all drink",
    "6": "6 for dicks ‚Äì we all drink",
    "7": "Heaven ‚Äì last to react drinks",
    "J": "Thumbmaster ‚Äì last to react drinks",
    "K": "King ‚Äì make a rule"
  };

  const turnText = document.getElementById("turnText");
  const turnHint = document.getElementById("turnHint");

  const roundPill = document.getElementById("roundPill");
  const roundText = document.getElementById("roundText");
  const roundSub  = document.getElementById("roundSub");

  const centerCard = document.getElementById("centerCard");
  const drawBtn = document.getElementById("drawBtn");

  const toast = document.getElementById("toast");

  // Desktop panel
  const progressChip = document.getElementById("progressChip");
  const leftChip = document.getElementById("leftChip");
  const historyWrap = document.getElementById("historyWrap");
  const thumbVal = document.getElementById("thumbVal");
  const heavenVal = document.getElementById("heavenVal");
  const startJBtn = document.getElementById("startJBtn");
  const start7Btn = document.getElementById("start7Btn");
  const clearRoundBtn = document.getElementById("clearRoundBtn");
  const restartDeckBtn = document.getElementById("restartDeckBtn");

  // Mobile sheet
  const hudBtn = document.getElementById("hudBtn");
  const sheetOverlay = document.getElementById("sheetOverlay");
  const sheetClose = document.getElementById("sheetClose");
  const mProgressChip = document.getElementById("mProgressChip");
  const mLeftChip = document.getElementById("mLeftChip");
  const mHistoryWrap = document.getElementById("mHistoryWrap");
  const mThumbVal = document.getElementById("mThumbVal");
  const mHeavenVal = document.getElementById("mHeavenVal");
  const mStartJBtn = document.getElementById("mStartJBtn");
  const mStart7Btn = document.getElementById("mStart7Btn");
  const mClearRoundBtn = document.getElementById("mClearRoundBtn");
  const mRestartDeckBtn = document.getElementById("mRestartDeckBtn");

  function openSheet(){ document.body.classList.add("sheetOpen"); }
  function closeSheet(){ document.body.classList.remove("sheetOpen"); }

  hudBtn.addEventListener("click", openSheet);
  sheetOverlay.addEventListener("click", closeSheet);
  sheetClose.addEventListener("click", closeSheet);

  // Game state
  let turnIdx = 0;
  let deck = [];
  let idx = 0;
  let history = [];

  // Sticky owners
  const sticky = { J:null, "7":null };

  // Round state (NO TIMER)
  const round = {
    active:false,
    type:null,        // "J" or "7"
    startedBy:null,
    reacted: new Set(),   // playerIds
    lastReactor:null      // playerId
  };

  function showToast(msg){
    toast.textContent = msg;
    toast.style.opacity = "1";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => toast.style.opacity = "0", 1400);
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function buildDeck(){
    const suits = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
    const ranks = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];
    const d = [];
    for (const r of ranks) for (const s of suits) d.push(`${r}${s}`);
    // shuffle
    for (let i = d.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [d[i], d[j]] = [d[j], d[i]];
    }
    return d;
  }

  function addDrink(playerId, amt=1){
    const p = players.find(x => x.id === playerId);
    if (!p) return;
    p.drinks += amt;
    const el = document.getElementById(`tile-${playerId}`);
    if (el) el.querySelector(".drinkCount").textContent = p.drinks;
  }

  function addAllDrinks(amt=1){
    players.forEach(p => addDrink(p.id, amt));
  }

  function setCenterIdle(){
    centerCard.innerHTML = `
      <div class="cardMid">Draw a card<br/>No mercy</div>
      <div class="cardFooter" style="visibility:hidden"></div>
    `;
  }

  function setCenterCard({face, rule, by}){
    centerCard.innerHTML = `
      <div class="cardTop">
        <div class="cardFace">${escapeHtml(face)}</div>
        <div class="cardRule">${escapeHtml(rule || "")}</div>
      </div>
      <div class="cardMid"></div>
      <div class="cardFooter" style="visibility:visible">${escapeHtml(by || "")}</div>
    `;
  }

  function renderPanels(){
    const prog = `${idx} / 52`;
    const left = `${52 - idx} left`;
    progressChip.textContent = prog;
    leftChip.textContent = left;
    mProgressChip.textContent = prog;
    mLeftChip.textContent = left;

    const h = history.slice(0, 6).map(x => `<div class="hist">${escapeHtml(x)}</div>`).join("");
    historyWrap.innerHTML = h;
    mHistoryWrap.innerHTML = h;

    thumbVal.textContent = sticky.J || "None";
    heavenVal.textContent = sticky["7"] || "None";
    mThumbVal.textContent = sticky.J || "None";
    mHeavenVal.textContent = sticky["7"] || "None";

    // enable start buttons only if there is an owner AND round not active
    const canStartJ = !!sticky.J && !round.active;
    const canStart7 = !!sticky["7"] && !round.active;

    startJBtn.disabled = !canStartJ;
    start7Btn.disabled = !canStart7;
    mStartJBtn.disabled = !canStartJ;
    mStart7Btn.disabled = !canStart7;

    // flash the start button when it‚Äôs available
    startJBtn.classList.toggle("flashBtn", canStartJ);
    start7Btn.classList.toggle("flashBtn", canStart7);
    mStartJBtn.classList.toggle("flashBtn", canStartJ);
    mStart7Btn.classList.toggle("flashBtn", canStart7);
  }

  function setTurn(i){
    turnIdx = (i + players.length) % players.length;
    const who = players[turnIdx].name;
    turnText.textContent = `${who.toUpperCase()}‚ÄôS TURN`;
    turnHint.style.display = round.active ? "none" : "inline";
    players.forEach(p => {
      const el = document.getElementById(`tile-${p.id}`);
      if (!el) return;
      el.classList.toggle("turn", p === players[turnIdx]);
    });
  }

  function tileEl(p){
    const div = document.createElement("div");
    div.innerHTML = `
      <div class="tile" id="tile-${p.id}">
        <div class="turnTag">TURN</div>
        <div class="avatar"></div>
        <div>
          <div class="name">${p.name}</div>
          <div class="stats"><span>üç∫</span><span class="drinkCount">${p.drinks}</span></div>
        </div>
        <button class="plusBtn">+1 Beer</button>
        <button class="reactBtn" data-react="${p.id}">REACT</button>
      </div>
    `.trim();

    const tile = div.firstChild;

    // set turn by tapping tile (disabled during round)
    tile.addEventListener("click", () => {
      if (round.active) return;
      const idx = players.findIndex(x => x.id === p.id);
      setTurn(idx);
    });

    tile.querySelector(".plusBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      addDrink(p.id, 1);
    });

    tile.querySelector(".reactBtn").addEventListener("click", (e) => {
      e.stopPropagation();
      react(p.id);
    });

    return tile;
  }

  function mountPlayers(){
    players.forEach(p => {
      const slot = document.getElementById(p.slot);
      slot.innerHTML = "";
      slot.appendChild(tileEl(p));
    });
  }

  function startRound(type){
    if (round.active) return;

    const owner = sticky[type];
    if (!owner) return;

    round.active = true;
    round.type = type;
    round.startedBy = owner;
    round.reacted = new Set();
    round.lastReactor = null;

    document.body.classList.add("roundActive");

    // flashing ‚ÄúSTART‚Äù indicator for everyone
    const label = (type === "J") ? "THUMBS DOWN" : "FINGER IN AIR";
    roundText.textContent = (type === "J") ? "THUMBS! REACT" : "HEAVEN! REACT";
    roundSub.textContent = label;

    // make every REACT button flash until pressed
    document.querySelectorAll(".reactBtn").forEach(btn => btn.classList.add("flashBtn"));

    showToast(`${owner} started ${type === "J" ? "Thumbmaster" : "Heaven"}`);

    // show center card hint (small and clear)
    setCenterCard({
      face: type,
      rule: (type === "J") ? "Thumbs down. Tap REACT." : "Finger up. Tap REACT.",
      by: `Started by: ${owner}`
    });

    renderPanels();
    closeSheet();
  }

  function endRoundIfDone(){
    if (!round.active) return;
    if (round.reacted.size < players.length) return;

    // lastReactor loses
    const loserId = round.lastReactor;
    const loserName = players.find(p => p.id === loserId)?.name || "Someone";

    addDrink(loserId, 1);
    showToast(`${loserName} drinks (+1)`);

    setCenterCard({
      face: "LAST",
      rule: `${loserName} loses`,
      by: round.type === "J" ? "Thumbmaster (J)" : "Heaven (7)"
    });

    clearRound(false);
  }

  function react(playerId){
    if (!round.active) return;

    // one reaction per person per round
    if (round.reacted.has(playerId)) return;

    round.reacted.add(playerId);
    round.lastReactor = playerId;

    // stop flashing for that player's button + lock it visually
    const tile = document.getElementById(`tile-${playerId}`);
    if (tile){
      const btn = tile.querySelector(".reactBtn");
      btn.classList.remove("flashBtn");
      btn.textContent = "LOCKED";
      btn.style.opacity = ".55";
      btn.disabled = true;
    }

    // when everyone reacted, punish the last
    endRoundIfDone();
  }

  function clearRound(resetCenter=true){
    round.active = false;
    round.type = null;
    round.startedBy = null;
    round.reacted = new Set();
    round.lastReactor = null;

    document.body.classList.remove("roundActive");

    // reset react buttons
    document.querySelectorAll(".reactBtn").forEach(btn => {
      btn.classList.remove("flashBtn");
      btn.textContent = "REACT";
      btn.style.opacity = "";
      btn.disabled = false;
    });

    if (resetCenter) setCenterIdle();
    renderPanels();
  }

  function restartDeck(){
    deck = buildDeck();
    idx = 0;
    history = [];
    sticky.J = null;
    sticky["7"] = null;

    players.forEach(p => p.drinks = 0);
    mountPlayers();

    clearRound(true);
    setTurn(0);
    renderPanels();
    setCenterIdle();
    showToast("Restarted");
  }

  function drawCard(){
    if (round.active){
      showToast("Finish the round first");
      return;
    }
    if (idx >= 52){
      showToast("Deck empty. Restart.");
      return;
    }

    const drawer = players[turnIdx].name;
    const card = deck[idx++];
    const rank = card.slice(0, -1);

    history.unshift(card);

    // Sticky owners
    if (rank === "J") sticky.J = drawer;
    if (rank === "7") sticky["7"] = drawer;

    // Auto rules you specified
    if (rank === "4" || rank === "6"){
      addAllDrinks(1);
      showToast("Everyone drinks üçª");
    }

    if (rank === "K"){
      // Game continues until all 52, but king still makes a rule (you can expand this later)
      setTimeout(() => {
        const text = prompt("King rule:", "");
        if (text) showToast(`Rule added: ${text.trim()}`);
      }, 30);
    }

    setCenterCard({
      face: card,
      rule: rules[rank] || "",
      by: `Drew: ${drawer}`
    });

    setTurn(turnIdx + 1);
    renderPanels();

    if (idx >= 52){
      showToast("All 52 drawn ‚úÖ");
    }
  }

  // Button wiring
  drawBtn.addEventListener("click", drawCard);

  startJBtn.addEventListener("click", () => startRound("J"));
  start7Btn.addEventListener("click", () => startRound("7"));
  mStartJBtn.addEventListener("click", () => startRound("J"));
  mStart7Btn.addEventListener("click", () => startRound("7"));

  clearRoundBtn.addEventListener("click", () => { clearRound(true); showToast("Cleared"); });
  mClearRoundBtn.addEventListener("click", () => { clearRound(true); showToast("Cleared"); });

  restartDeckBtn.addEventListener("click", restartDeck);
  mRestartDeckBtn.addEventListener("click", restartDeck);

  // Init
  window.addEventListener("load", () => {
    deck = buildDeck();
    mountPlayers();
    setTurn(0);
    setCenterIdle();
    renderPanels();
  });
</script>
</body>
</html>
